resources:
  jobs:
    price_transparency_job:
      name: Price Transparency (Healthcare)

      trigger:
        # Run this job every day, exactly one day from the last run; see https://docs.databricks.com/api/workspace/jobs/create#trigger
        periodic:
          interval: 1
          unit: DAYS

      email_notifications:
        on_failure: ${var.notifications}

      tasks:
        - task_key: initial_set_up
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.run_initial_setup}}"
            right: "true"
        - task_key: create_volume_subdirs
          depends_on:
            - task_key: initial_set_up
              outcome: "true"
          for_each_task:
            inputs: '["index", "in-network", "in-network/uncompressed", "in-network/original", "in-network/split", "allowed-amount", "allowed-amount/uncompressed", "allowed-amount/original", "allowed-amount/split"]'
            concurrency: 10
            task:
              task_key: create_volume_subdirs_iteration
              notebook_task:
                notebook_path: ../src/00 - Create Volume Subpaths.ipynb
                base_parameters:
                  subdirectory: "{{input}}"
                source: WORKSPACE
        - task_key: copy_index_to_volume
          depends_on:
            - task_key: create_volume_subdirs
          notebook_task:
            notebook_path: ../src/01 - Copy Index JSON to the Volume.ipynb
            base_parameters:
              subdirectory: ${var.index_subdirectory}
              index_file_name: ${var.initial_index_file_name}
            source: WORKSPACE

        # - task_key: refresh_pipeline
        #   pipeline_task:
        #     pipeline_id: ${resources.pipelines.ingestion_pipeline.id}
                
      queue:
        enabled: true
      parameters:
        - name: catalog_use
          default: ${var.catalog}
        - name: schema_use
          default: ${resources.schemas.price_transparency_schema.name}
        - name: volume_use
          default: ${resources.volumes.price_transparency_volume.name}
        - name: run_initial_setup
          default: ${var.run_initial_setup}